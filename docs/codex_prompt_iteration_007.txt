You are continuing development of the app “glance”.

Current capabilities:
- Photino desktop app
- ASP.NET Core backend
- Vue UI
- Rich-text editor with images
- SQLite persistence with migrations
- Multi-instance sync
- Dashboard category derivation
- History tab with chart
- scheduled_date and recurrence_json fields already exist

DO NOT BREAK EXISTING FUNCTIONALITY.

==================================================
AUTHORITATIVE DOCUMENTS (DO NOT MODIFY)
==================================================

- docs/architecture.md
- docs/requirements.feature
- docs/api.md
- docs/schema.sql
- docs/migrations/*

==================================================
GOAL: ITERATION 7
==================================================

Implement **recurrence logic and task generation**, as specified in
requirements.feature.

After this iteration:
- Users can mark tasks as repeatable / daily / weekly / monthly
- Future tasks are automatically generated
- Generated tasks appear correctly on the Dashboard
- No duplicate future tasks are created

==================================================
RECURRENCE MODEL (MANDATORY)
==================================================

Use existing field:
- tasks.recurrence_json

Define recurrence_json structure (authoritative for this iteration):

{
  "type": "repeatable" | "weekly" | "monthly",
  "weekdays": [1,2,3,4,5],        // only for weekly (1=Mon … 7=Sun)
  "monthDays": [1,15,30]          // only for monthly
}

Rules:
- repeatable:
  - task stays under "Repeatable"
  - no automatic scheduled_date
- weekly:
  - generates tasks on selected weekdays
- monthly:
  - generates tasks on selected days of month
  - skip invalid dates (e.g. Feb 30)

==================================================
TASK GENERATION RULES (MANDATORY)
==================================================

Generation window:
- Always ensure tasks exist for the next 4 weeks (rolling window)

When generation runs:
- On app startup
- When the day changes while app is running
- When recurrence_json is added or modified

Generation rules:
- Generated tasks:
  - are copies of the original task
  - have recurrence_json = null
  - have scheduled_date set
  - appear under appropriate Week category
- Original recurring task:
  - remains under "Repeatable"
  - is never auto-completed
- Do NOT generate duplicates:
  - before creating a task for a given date,
    check whether a task already exists for that date
    and original task identity

==================================================
IDENTITY / DEDUPLICATION (IMPORTANT)
==================================================

To avoid duplicates:
- Store the original recurring task id inside generated tasks
  (e.g. in recurrence_json or a dedicated field if already present)
- Deduplication must be deterministic across app restarts
- Last-write-wins is acceptable; duplicate prevention is required

DO NOT introduce background schedulers or OS timers.

==================================================
DASHBOARD BEHAVIOR
==================================================

- Generated tasks appear like normal tasks
- They can be completed independently
- Completing a generated task does NOT affect the original recurring task

==================================================
BACKEND RESPONSIBILITIES
==================================================

- Implement recurrence evaluation and generation logic server-side
- Prefer a single deterministic function:
  - Input: now, tasks with recurrence_json
  - Output: missing future tasks to create
- Keep generation idempotent

==================================================
FRONTEND RESPONSIBILITIES
==================================================

- Use existing UI controls (from Iteration 6 hover buttons) to set recurrence_json
- Trigger backend generation when recurrence changes
- Refresh Dashboard after generation

==================================================
MULTI-INSTANCE BEHAVIOR
==================================================

- Generation must be safe if two instances run simultaneously
- Duplicate generation must not occur
- Last-write-wins is acceptable; duplicates are not

==================================================
NON-GOALS (DO NOT IMPLEMENT)
==================================================

- Editing recurrence UI beyond what already exists
- Skipping/pausing recurrence
- Editing generated tasks back into recurrence
- Notifications or reminders

==================================================
DELIVERABLES
==================================================

- Recurrence rules work as specified
- Tasks are generated for next 4 weeks only
- No duplicate generated tasks occur
- Restarting the app does not create duplicates
- Brief notes describing:
  - recurrence_json structure
  - generation trigger points
  - deduplication strategy

Proceed by implementing backend recurrence logic first,
then wire generation triggers,
then verify Dashboard behavior.
Do not refactor unrelated code.
